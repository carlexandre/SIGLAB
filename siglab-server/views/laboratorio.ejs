<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
    <title>SIGLAB - Laborat√≥rio <%= lab.id %></title>
    
    <link href="/css/laboratorios.css" rel="stylesheet">
    
    <link href="https://fonts.googleapis.com/css2?family=VT323&family=Press+Start+2P&display=swap" rel="stylesheet">
</head>

<body>
    
    <%- include('partials/header') %> 

    <main>
        <h1 class="titulo-pagina"><%= lab.nome %></h1>

        <p class="subtitulo-localizacao">
            <%= lab.localizacao %>
        </p>

        <!-- pain√©is de informa√ß√£o -->
        <div class="info-panels-container">
            
            <a href="/disponibilidade/<%= lab.id %>" class="info-card-link">
                <div class="info-card">
                    <h2>Disponibilidade do Laborat√≥rio</h2>
                </div>
            </a>
            
            <a href="/laboratorios/<%= lab.id %>/avisos" class="info-card-link">
                <div class="info-card">
                    <h2>Avisos</h2>
                </div>
            </a>

            <% if (user && user.tipo === 'admin') { %>
                <a href="/historico/<%= lab.id %>" class="info-card-link">
                    <div class="info-card">
                        <h2>Hist√≥rico</h2>
                    </div>
                </a>
            <% } %>
        </div>

        <!-- MODAL DE CADASTRO DE DISPOSITIVO -->
        <% if (user && user.tipo === 'admin') { %>
            <div id="modalDispositivo" class="modal">
                <div class="modal-content">
                    <span class="close-btn" onclick="closeModal()">&times;</span>
                    <h3>> Gerenciar_Dispositivos_</h3>
                    
                    <!-- Cadastro Manual -->
                    <form action="/laboratorios/<%= lab.id %>/dispositivos" method="POST" class="modal-form">
                        <label style="color: #fff; border-bottom: 1px solid #005500; padding-bottom: 5px;">[ MODO MANUAL ]</label>
                        
                        <label for="nome">Nome do Dispositivo:</label>
                        <input type="text" id="nome" name="nome" placeholder="Ex: PC_01" required>
                        
                        <label for="tipo">Tipo:</label>
                        <select id="tipo" name="tipo" required>
                            <option value="" disabled selected>SELECIONE...</option>
                            <option value="computador">COMPUTADOR</option>
                            <option value="projetor">PROJETOR</option>
                            <option value="impressora">IMPRESSORA</option>
                        </select>
                        
                        <label for="status">Status Inicial:</label>
                        <select id="status" name="status" required>
                            <option value="livre">LIVRE</option>
                            <option value="em_uso">EM USO</option>
                            <option value="inoperante">INOPERANTE</option>
                        </select>

                        <button type="submit">CONFIRMAR INSER√á√ÉO</button>
                    </form>

                    <!-- Divis√≥ria Visual -->
                    <div class="modal-divider">
                        <span>OU IMPORTAR EM MASSA</span>
                    </div>

                    <!-- Importa√ß√£o CSV -->
                    <div class="import-section">
                        <!-- Input Escondido para Upload -->
                        <input type="file" id="csvFileInput" accept=".csv" style="display: none;" onchange="handleFileSelect(event)">
                        
                        <button onclick="document.getElementById('csvFileInput').click()" class="btn-action btn-import-modal">
                            üì• Carregar Arquivo CSV
                        </button>
                        <p style="font-size: 0.9rem; color: #005500; margin-top: 5px;">*Formato: Nome,Tipo,Status</p>
                    </div>
                </div>
            </div>
        <% } %>

        <!-- container da topologia -->
        <div class="topology-container">
            <!-- HEADER DA TOPOLOGIA COM BOT√ïES DE A√á√ÉO -->
            <div class="topology-header">
                <h2>Topologia do Laborat√≥rio</h2>
                
                <% if (user && user.tipo === 'admin') { %>
                    <div class="header-buttons">
                        <!-- Bot√£o de Editar Topologia -->
                        <button id="btnToggleEdit" onclick="toggleEditMode()" class="btn-action btn-edit-topology">
                            <h3 id="btnEditText">üìê Editar Topologia</h3>
                        </button>

                        <button onclick="openModal()" class="btn-action">
                            <h3>+ Novo Dispositivo</h3>
                        </button>
                    </div>
                <% } %>
            </div>
            
            <div class="topology-map" id="topologyMap">
                <!-- 
                  looping EJS para listar os dispositivos 
                -->
                <% if (lab.dispositivos && lab.dispositivos.length > 0) { %>
                    <% lab.dispositivos.forEach(disp => { %>
                        
                        <!-- 
                           Dispositivo com coordenadas de grid e atributos de Drag & Drop
                        -->
                        <div class="device <%= disp.status %>" 
                             id="<%= disp.id_dispositivo %>"
                             style="grid-area: <%= disp.posicao ? disp.posicao.row : '1' %> / <%= disp.posicao ? disp.posicao.col : '1' %>;"
                             data-nome="<%= disp.nome %>">
                            
                            <span class="status-label">
                                <%= disp.status.replace('_', ' ') %>
                            </span>

                            <span class="device-icon">
                                <% if (disp.tipo === 'projetor') { %>
                                    üìΩÔ∏è
                                <% } else if (disp.tipo === 'impressora') { %>
                                    üñ®Ô∏è
                                <% } else { %>
                                    üñ•Ô∏è
                                <% } %>
                            </span>

                            <!-- Tooltip (Menu de a√ß√µes e detalhes) -->
                            <div class="tooltip">
                                <div class="tooltip-content">
                                    <p><strong>ID:</strong> <%= disp.nome %></p>
                                    <p><strong>Tipo:</strong> <%= disp.tipo %></p>
                                    <hr style="border-color: inherit; margin: 5px 0; opacity: 0.5;">
                                    
                                    <a href="/laboratorios/<%= lab.id %>/report/<%= disp.id_dispositivo %>" class="tooltip-btn btn-report">Reportar Problema</a>
                                    
                                    <% if (user && user.tipo === 'admin') { %>
                                        <form action="/laboratorios/<%= lab.id %>/dispositivos/<%= disp.id_dispositivo %>/delete" method="POST" onsubmit="return confirm('ATEN√á√ÉO ADMIN:\n\nTem certeza que deseja EXCLUIR permanentemente o dispositivo \'<%= disp.nome %>\'?');">
                                            <button type="submit" class="tooltip-btn btn-delete-device">Excluir</button>
                                        </form>
                                    <% } %>
                                </div>
                            </div>
                        </div>
                    
                    <% }); %>
                <% } else { %>
                    <!-- Se n√£o houver dispositivos, exibe mensagem ocupando toda a grade -->
                    <p style="grid-column: 1 / -1; text-align: center; color: #666; font-size: 1.2rem; margin-top: 50px;">
                        [ SISTEMA: Nenhum dispositivo detectado neste setor. ]
                    </p>
                <% } %>
            </div>
        </div>
    </main>

    <%- include('partials/footer') %> 

    <script>
        // --- VARI√ÅVEIS DE CONTROLE DE EDI√á√ÉO ---
        let isEditMode = false;
        let draggedElement = null;
        
        // Armazena a posi√ß√£o de origem para o SWAP
        let sourceRow = null;
        let sourceCol = null;

        const topologyMap = document.getElementById('topologyMap');

        // --- L√ìGICA DE DRAG AND DROP (TOPOLOGIA) ---
        
        function toggleEditMode() {
            isEditMode = !isEditMode;
            const btn = document.getElementById('btnToggleEdit');
            const btnText = document.getElementById('btnEditText');
            const devices = document.querySelectorAll('.device');

            if (isEditMode) {
                // ATIVAR MODO EDI√á√ÉO
                topologyMap.classList.add('editing');
                btn.classList.add('saving');
                btnText.innerText = 'üíæ SALVAR MATRIZ';
                
                // Habilitar arraste nos dispositivos
                devices.forEach(dev => {
                    dev.setAttribute('draggable', 'true');
                    addDragEvents(dev);
                });

                // Habilitar drop no mapa
                addMapDropEvents();

            } else {
                // SALVAR E SAIR
                saveTopology();
            }
        }

        async function saveTopology() {
            const devices = document.querySelectorAll('.device');
            const positions = [];

            devices.forEach(dev => {
                // Pega o estilo computado final (ap√≥s o drop)
                const style = window.getComputedStyle(dev);
                const row = style.gridRowStart;
                const col = style.gridColumnStart;
                
                // Salvar apenas se tiver posi√ß√£o v√°lida num√©rica
                if (row && col && !isNaN(parseInt(row)) && !isNaN(parseInt(col))) {
                    positions.push({
                        id_dispositivo: dev.id,
                        row: parseInt(row),
                        col: parseInt(col)
                    });
                }
            });

            // Feedback visual de salvamento
            const btnText = document.getElementById('btnEditText');
            btnText.innerText = 'SALVANDO...';

            try {
                const idLab = "<%= lab.id %>";
                const response = await fetch(`/laboratorios/${idLab}/salvar_topologia`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ posicoes: positions })
                });

                const result = await response.json();

                if (result.success) {
                    // DESATIVAR MODO EDI√á√ÉO
                    const btn = document.getElementById('btnToggleEdit');
                    topologyMap.classList.remove('editing');
                    btn.classList.remove('saving');
                    btnText.innerText = 'üìê Editar Topologia';

                    // Remover eventos de drag
                    devices.forEach(dev => {
                        dev.setAttribute('draggable', 'false');
                        removeDragEvents(dev);
                    });
                    
                } else {
                    alert("Erro ao salvar: " + result.message);
                    btnText.innerText = 'üíæ TENTAR NOVAMENTE';
                    isEditMode = true; // Mant√©m no modo edi√ß√£o
                }
            } catch (err) {
                console.error(err);
                alert("Erro de conex√£o ao salvar.");
                btnText.innerText = 'üíæ TENTAR NOVAMENTE';
            }
        }

        // --- EVENTOS DE DRAG NATIVE HTML5 ---

        function addDragEvents(element) {
            element.addEventListener('dragstart', handleDragStart);
            element.addEventListener('dragend', handleDragEnd);
        }

        function removeDragEvents(element) {
            element.removeEventListener('dragstart', handleDragStart);
            element.removeEventListener('dragend', handleDragEnd);
        }

        function handleDragStart(e) {
            draggedElement = this;
            
            // Captura a posi√ß√£o original (row/col) antes de arrastar
            // Usamos getComputedStyle para garantir que pegamos o valor real do grid
            const style = window.getComputedStyle(this);
            sourceRow = parseInt(style.gridRowStart);
            sourceCol = parseInt(style.gridColumnStart);

            e.dataTransfer.effectAllowed = 'move';
            this.style.opacity = '0.4';
            this.style.zIndex = '1000'; // Trazer para frente
        }

        function handleDragEnd(e) {
            this.style.opacity = '1';
            this.style.zIndex = '';
            draggedElement = null;
            sourceRow = null;
            sourceCol = null;
        }

        function addMapDropEvents() {
            topologyMap.addEventListener('dragover', handleDragOver);
            topologyMap.addEventListener('drop', handleDrop);
        }

        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault(); // Necess√°rio para permitir o drop
            }
            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        function handleDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }

            if (draggedElement) {
                // CALCULAR C√âLULA DO GRID BASEADO NA POSI√á√ÉO DO MOUSE
                const rect = topologyMap.getBoundingClientRect();
                const offsetX = e.clientX - rect.left;
                const offsetY = e.clientY - rect.top;

                // Grid-auto-rows: 80px
                // Colunas: 1fr (total / 12)
                const colWidth = rect.width / 12; 
                const rowHeight = 80; 

                // Calcula √≠ndice (m√≠nimo 1, m√°ximo 12)
                let targetCol = Math.max(1, Math.min(12, Math.ceil(offsetX / colWidth)));
                let targetRow = Math.max(1, Math.ceil(offsetY / rowHeight));

                // L√ìGICA DE SWAP (TROCA)
                // Verifica se j√° existe algu√©m na posi√ß√£o alvo
                const allDevices = document.querySelectorAll('.device');
                let existingDevice = null;

                allDevices.forEach(dev => {
                    if (dev === draggedElement) return;

                    const style = window.getComputedStyle(dev);
                    const r = parseInt(style.gridRowStart);
                    const c = parseInt(style.gridColumnStart);

                    if (r === targetRow && c === targetCol) {
                        existingDevice = dev;
                    }
                });

                if (existingDevice) {
                    // SE EXISTIR DISPOSITIVO NO ALVO, ELE VAI PARA A POSI√á√ÉO ORIGINAL DO ARRASTADO
                    // Garante que temos valores v√°lidos para a origem
                    const safeSourceRow = isNaN(sourceRow) ? 1 : sourceRow;
                    const safeSourceCol = isNaN(sourceCol) ? 1 : sourceCol;

                    existingDevice.style.gridArea = `${safeSourceRow} / ${safeSourceCol}`;
                }

                // Move o elemento arrastado para o alvo
                draggedElement.style.gridArea = `${targetRow} / ${targetCol}`;
            }

            return false;
        }

        // --- L√ìGICA DO MODAL ---
        const modal = document.getElementById("modalDispositivo");
        
        function openModal() {
            if(modal) modal.style.display = "block";
        }

        function closeModal() {
            if(modal) modal.style.display = "none";
        }

        window.onclick = function(event) {
            if (event.target == modal) {
                closeModal();
            }
        }

        // --- L√ìGICA DE IMPORTA√á√ÉO CSV ---
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();

            reader.onload = function(e) {
                const text = e.target.result;
                processCSV(text);
            };

            reader.readAsText(file);
        }

        function processCSV(csvText) {
            const lines = csvText.trim().split(/\r\n|\n/);
            
            if (lines.length < 2) {
                alert("Erro: Arquivo CSV vazio ou inv√°lido.");
                return;
            }

            const dispositivos = [];

            for (let i = 1; i < lines.length; i++) {
                const row = lines[i].split(',');
                
                if (row.length >= 3) {
                    const nome = row[0].trim();
                    const tipo = row[1].trim();
                    const status = row[2].trim();

                    if (nome && tipo) {
                        dispositivos.push({ nome, tipo, status });
                    }
                }
            }

            if (dispositivos.length === 0) {
                alert("Nenhum dispositivo v√°lido encontrado no CSV.");
                return;
            }

            sendDataToServer(dispositivos);
        }

        async function sendDataToServer(data) {
            const idLab = "<%= lab.id %>";
            
            try {
                const response = await fetch(`/laboratorios/${idLab}/importar`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ dispositivos: data })
                });

                const result = await response.json();

                if (result.success) {
                    alert(result.message);
                    window.location.reload(); 
                } else {
                    alert("Erro ao importar: " + result.message);
                }

            } catch (error) {
                console.error("Erro:", error);
                alert("Erro de conex√£o ao tentar importar.");
            }
        }
    </script>

</body>
</html>      