<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIGLAB: Gestão de Chamados</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=VT323&display=swap" rel="stylesheet">
    <link href="/css/chamados.css" rel="stylesheet">
</head>

<%- include('partials/header') %>

<body>
    
    <main>
        <h1 class="titulo-pagina">Central de Chamados</h1>

        <div class="tab-nav">
            <button class="tab-link active" data-target="ativos">Chamados Ativos</button>
            <button class="tab-link" data-target="resolvidos">Histórico (Fechados)</button>
        </div>
        
        <!-- Pequena função helper para formatar datas no EJS -->
        <% 
            function formatarData(isoStr) {
                if (!isoStr) return 'Data desconhecida';
                const d = new Date(isoStr);
                return d.toLocaleDateString('pt-BR') + ' ' + d.toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'});
            }
        %>

        <!-- ativos -->
        <div class="tab-content active" id="ativos">
            
            <div class="chamados-grid">
                <% 
                const ativos = listaChamados.filter(c => c.status !== 'resolvido');
                
                if (ativos.length > 0) {
                    ativos.forEach(chamado => { 
                %>
                    <div class="card-chamado" onclick="abrirModal('<%= JSON.stringify(chamado) %>')">
                        <div>
                            <span class="badge badge-<%= chamado.gravidade %>"><%= chamado.gravidade %></span>
                            <div style="clear:both; height: 10px;"></div>
                            <div class="card-info">
                                <h3><%= chamado.titulo %></h3>
                            </div>
                        </div>
                        <div class="card-meta">
                            LAB: <%= chamado.id_lab %> <br> 
                            ID: <%= chamado.id_dispositivo %> <br>
                            <span style="color: #888;">Cat: <%= chamado.tipo_problema %></span><br>
                            <span style="font-size: 0.8rem; color: #aaa;">
                                Aberto em: <%= formatarData(chamado.data_abertura) %>
                            </span>
                        </div>
                    </div>
                <% 
                    }); 
                } else { 
                %>
                    <div style="grid-column: 1 / -1; text-align: center; padding: 40px; border: 1px dashed var(--dim-green); opacity: 0.7;">
                        <p style="font-size: 1.5rem;">Nenhum chamado ativo.</p>
                        <p>Todos os sistemas operacionais.</p>
                    </div>
                <% } %>
            </div>
        </div>

        <!-- resolvidos -->
        <div class="tab-content" id="resolvidos">
            
            <div style="margin-bottom: 15px; color: #666; font-size: 0.9rem;">
                CHAMADOS RESOLVIDOS
            </div>

            <div class="chamados-grid">
                <% 
                const resolvidos = listaChamados.filter(c => c.status === 'resolvido');
                
                if (resolvidos.length > 0) {
                    resolvidos.forEach(chamado => { 
                %>
                    <div class="card-chamado resolvido" onclick="abrirModal('<%= JSON.stringify(chamado) %>')">
                        <div>
                            <span class="badge" style="border-color: #555; color: #555;">FECHADO</span>
                            <div style="clear:both; height: 10px;"></div>
                            <div class="card-info">
                                <h3 style="color: #888;"><%= chamado.titulo %></h3>
                            </div>
                        </div>
                        <div class="card-meta" style="color: #555; border-top-color: #333;">
                            <%= chamado.id_lab %> - <%= chamado.id_dispositivo %> <br>
                            <span style="font-size: 0.8rem;">
                                Fechado em: <%= formatarData(chamado.data_fechamento) %>
                            </span>
                        </div>
                    </div>
                <% 
                    });
                } else {
                %>
                    <p style="color: #555;">Nenhum histórico encontrado.</p>
                <% } %>
            </div>
        </div>

    </main>

    <!-- modal -->
    <div id="modalDetalhes" class="modal-overlay">
        <div class="modal-content">
            <span class="close-btn" onclick="fecharModal()">X</span>
            
            <h2 id="modalTitulo" style="font-size: 1rem; margin-bottom: 20px; color: var(--alert-pink); border-bottom: 1px solid var(--alert-pink); padding-bottom: 10px;">DETALHES</h2>
            
            <div class="detail-row">
                <span class="detail-label">Localização:</span>
                <span id="modalLocal" class="detail-value">...</span>
            </div>

            <div class="detail-row">
                <span class="detail-label">Categoria / Gravidade:</span>
                <span id="modalCat" class="detail-value">...</span>
            </div>

            <div class="detail-row">
                <span class="detail-label">Descrição do Usuário:</span>
                <p id="modalDesc" class="detail-value" style="font-style: italic; color: #fff; font-size: 1.1rem; margin-top:5px;">...</p>
            </div>

            <form id="formAnotacao" method="POST" action="/chamados/anotar">
                <input type="hidden" name="id_chamado" id="inputIdChamado">
                
                <label class="detail-label" for="anotacoes" style="margin-top: 20px;">Solução / Notas:</label>
                <textarea name="anotacoes" id="inputAnotacoes" class="anotacao-input" rows="4"></textarea>

                <div style="display: flex; gap: 15px; justify-content: flex-end; margin-top: 20px;">
                    <button type="submit" name="acao" value="salvar" class="btn-action" style="background-color: #222; color: #fff; border: 1px solid #555;">
                        Salvar Nota
                    </button>
                    <!-- ID adicionado ao botão para manipular via JS -->
                    <button id="btnAcaoPrincipal" type="submit" name="acao" value="resolver" class="btn-action">
                        Marcar Resolvido
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // abas
        document.addEventListener('DOMContentLoaded', () => {
            const tabLinks = document.querySelectorAll('.tab-link');
            const tabContents = document.querySelectorAll('.tab-content');

            tabLinks.forEach(link => {
                link.addEventListener('click', () => {
                    const targetId = link.getAttribute('data-target');

                    // remove active de tudo
                    tabLinks.forEach(btn => btn.classList.remove('active'));
                    tabContents.forEach(content => content.classList.remove('active'));

                    // ativa o clicado
                    link.classList.add('active');
                    document.getElementById(targetId).classList.add('active');
                });
            });
        });

        // modal
        function abrirModal(chamadoString) {
            const chamado = JSON.parse(chamadoString);
            const modal = document.getElementById('modalDetalhes');
            
            document.getElementById('modalTitulo').innerText = chamado.titulo;
            document.getElementById('modalLocal').innerText = `Lab ${chamado.id_lab} >> ${chamado.id_dispositivo}`;
            document.getElementById('modalCat').innerText = `${chamado.tipo_problema} | ${chamado.gravidade}`;
            document.getElementById('modalDesc').innerText = `"${chamado.descricao}"`;
            
            document.getElementById('inputIdChamado').value = chamado.id || '0'; 
            document.getElementById('inputAnotacoes').value = chamado.anotacoes || '';

            // Lógica para alterar o botão de ação (Resolver vs Reabrir)
            const btnPrincipal = document.getElementById('btnAcaoPrincipal');
            
            if (chamado.status === 'resolvido') {
                btnPrincipal.innerText = "Reativar Chamado";
                btnPrincipal.value = "reabrir";
                btnPrincipal.style.borderColor = "var(--alert-pink)";
                btnPrincipal.style.color = "var(--alert-pink)";
            } else {
                btnPrincipal.innerText = "Marcar Resolvido";
                btnPrincipal.value = "resolver"; 
                btnPrincipal.style.borderColor = "var(--dim-green)"; 
                btnPrincipal.style.color = "var(--dim-green)";
            }

            modal.style.display = 'flex';
        }

        function fecharModal() {
            document.getElementById('modalDetalhes').style.display = 'none';
        }

        window.onclick = function(e) {
            if (e.target == document.getElementById('modalDetalhes')) fecharModal();
        }
    </script>

</body>

<%- include('partials/footer') %>

</html>