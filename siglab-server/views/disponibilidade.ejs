<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIGLAB: Disponibilidade <%= lab_id === 'geral' ? 'Geral' : 'Laboratório ' + lab_nome %></title>
    
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=VT323&display=swap" rel="stylesheet">
    <link href="/css/disponibilidade.css" rel="stylesheet">
</head>

<body>
    
    <%- include('partials/header') %>

    <main>
        <h1 class="titulo-pagina">Disponibilidade: <%= lab_id === 'geral' ? 'Geral' : lab_nome %></h1>

        <div class="agenda-container">
            
            <!-- calendário -->
            <div class="calendar-wrapper">
                <div class="calendar-header">
                    <button class="btn-nav" onclick="mudarMes(-1)">&lt; ANT</button>
                    <span id="mesAnoDisplay" style="color: #fff;">NOVEMBRO 2025</span>
                    <button class="btn-nav" onclick="mudarMes(1)">PROX &gt;</button>
                </div>

                <div class="calendar-grid">
                    <!-- dias da semana -->
                    <div class="weekday">DOM</div>
                    <div class="weekday">SEG</div>
                    <div class="weekday">TER</div>
                    <div class="weekday">QUA</div>
                    <div class="weekday">QUI</div>
                    <div class="weekday">SEX</div>
                    <div class="weekday">SÁB</div>

                    <!-- os dias serão gerados via JS -->
                    <div id="diasContainer" style="display: contents;"></div>
                </div>
            </div>

            <aside class="details-panel">
                <div class="details-header">
                    <div class="details-date" id="displayDataSelecionada">SELECIONE UM DIA</div>
                    <div style="font-size: 0.9rem; color: #888;">Detalhes da ocupação</div>
                </div>

                <ul class="reservation-list" id="listaReservas">
                    <li class="empty-state">Clique em um dia no calendário para ver a disponibilidade.</li>
                </ul>

                <% if(user && (user.tipo === 'admin' || user.tipo === 'professor')) { %>
                    <a href="#" id="btnNovaReserva" class="btn-reservar" style="display: none;">
                        + NOVA RESERVA NESTE DIA
                    </a>
                <% } %>
            </aside>

        </div>
    </main>

    <%- include('partials/footer') %>

    <script>
        const dadosBrutos = <%- JSON.stringify(reservas) %>;

        // Novo: Variavel para verificar permissão no JS
        const userType = "<%= user ? user.tipo : 'guest' %>";

        const currentLabId = "<%= lab_id === 'geral' ? '' : lab_id %>";
        
        // Objeto que vai alimentar o calendário
        const reservasDB = {};

        // Processa os dados brutos para o formato "YYYY-MM-DD": [Array]
        dadosBrutos.forEach(reserva => {
            // Suporta tanto o campo "data" quanto "data_inicio"
            const dataString = reserva.data_inicio;
            
            if (dataString) {
                // Extrai apenas a data YYYY-MM-DD (Evita bugs de fuso horário do objeto Date)
                // Ex: "2025-11-05T08:00" -> ["2025-11-05", "08:00"]
                const dataKey = dataString.split('T')[0];

                if (!reservasDB[dataKey]) {
                    reservasDB[dataKey] = [];
                }

                // Formatar hora
                let horarioFormatado = "Horário Indefinido";
                if (reserva.data_inicio && reserva.data_fim) {
                    // Pega o trecho da hora HH:MM direto da string
                    const hInicio = reserva.data_inicio.split('T')[1]?.substring(0, 5) || "";
                    const hFim = reserva.data_fim.split('T')[1]?.substring(0, 5) || "";
                    horarioFormatado = `${hInicio} - ${hFim}`;
                }

                reservasDB[dataKey].push({
                    id: reserva.id, // Novo: ID para exclusão
                    lab: `Lab ${reserva.id_lab}`,
                    hora: horarioFormatado,
                    user: reserva.name,
                    tipo: reserva.motivo || "Reserva"
                });
            }
        });

        let dataAtual = new Date();
        let diaSelecionado = null;

        const nomesMeses = ["JANEIRO", "FEVEREIRO", "MARÇO", "ABRIL", "MAIO", "JUNHO", "JULHO", "AGOSTO", "SETEMBRO", "OUTUBRO", "NOVEMBRO", "DEZEMBRO"];

        function renderizarCalendario() {
            const ano = dataAtual.getFullYear();
            const mes = dataAtual.getMonth();

            // Atualiza título
            document.getElementById('mesAnoDisplay').innerText = `${nomesMeses[mes]} ${ano}`;

            const container = document.getElementById('diasContainer');
            container.innerHTML = '';

            // Primeiro dia do mês e total de dias
            const primeiroDiaSemana = new Date(ano, mes, 1).getDay();
            const diasNoMes = new Date(ano, mes + 1, 0).getDate();

            // Células vazias antes do dia 1
            for (let i = 0; i < primeiroDiaSemana; i++) {
                const empty = document.createElement('div');
                empty.classList.add('day-cell');
                empty.style.border = 'none'; // Invisível
                empty.style.cursor = 'default';
                container.appendChild(empty);
            }

            // Dias do mês
            for (let dia = 1; dia <= diasNoMes; dia++) {
                const el = document.createElement('div');
                el.classList.add('day-cell');
                
                // Formata data string YYYY-MM-DD
                const diaStr = dia.toString().padStart(2, '0');
                const mesStr = (mes + 1).toString().padStart(2, '0');
                const dataKey = `${ano}-${mesStr}-${diaStr}`;

                // Verifica se tem reservas
                const temReservas = reservasDB[dataKey];
                const qtdReservas = temReservas ? temReservas.length : 0;

                // HTML interno da célula
                let htmlConteudo = `<div class="day-number">${dia}</div>`;
                
                if (qtdReservas > 0) {
                    htmlConteudo += `<div class="day-indicator">`;
                    // Adiciona um quadrado para cada reserva (max 3 visualmente)
                    for(let k=0; k<Math.min(qtdReservas, 4); k++) {
                        htmlConteudo += `<span class="dot"></span>`;
                    }
                    htmlConteudo += `</div>`;
                }

                el.innerHTML = htmlConteudo;

                // Evento de Click
                el.onclick = () => selecionarDia(el, dataKey, dia, mes, ano);

                container.appendChild(el);
            }
        }

        function selecionarDia(elemento, dataKey, dia, mes, ano) {
            // Remove classe active dos outros
            document.querySelectorAll('.day-cell').forEach(d => d.classList.remove('active'));
            elemento.classList.add('active');

            // Atualiza painel lateral
            const dataFormatada = `${dia} de ${nomesMeses[mes]} de ${ano}`;
            document.getElementById('displayDataSelecionada').innerText = dataFormatada;
            
            const lista = document.getElementById('listaReservas');
            lista.innerHTML = '';

            const reservas = reservasDB[dataKey];

            if (reservas && reservas.length > 0) {
                reservas.forEach(res => {
                    const li = document.createElement('li');
                    li.classList.add('reservation-item');
                    
                    // Novo: Lógica para mostrar botão de exclusão apenas para admin
                    let deleteButton = '';
                    if (userType === 'admin') {
                         deleteButton = `
                            <form action="/reservas/${res.id}/delete" method="POST" style="position: absolute; top: 9px; right: 9px;" onsubmit="return confirm('Deseja realmente deletar esta reserva?');">
                                <button type="submit" class="btn-delete">X</button>
                            </form>
                         `;
                    }

                    li.innerHTML = `
                        <div class="res-time">${res.hora}</div>
                        <div class="res-lab">${res.lab}</div>
                        <div class="res-user">${res.user} - ${res.tipo}</div>
                        ${deleteButton}
                    `;
                    lista.appendChild(li);
                });
            } else {
                lista.innerHTML = `<li class="empty-state">Nenhuma reserva encontrada para este dia.<br>O laboratório está livre.</li>`;
            }

            // Atualiza botão de nova reserva
            const btn = document.getElementById('btnNovaReserva');

            // Exemplo de link dinâmico
            let urlDestino = `/cadastro/reserva?data=${dataKey}`;
            if (currentLabId) {
                urlDestino += `&lab=${currentLabId}`;
            }

            btn.href = urlDestino;
            if (btn) { 
                btn.style.display = 'block';
                btn.innerText = `+ RESERVAR PARA ${dia}/${mes+1}`;
            }
        }

        function mudarMes(delta) {
            dataAtual.setMonth(dataAtual.getMonth() + delta);
            renderizarCalendario();
        }

        // Inicia
        document.addEventListener('DOMContentLoaded', renderizarCalendario);

    </script>
</body>
</html>