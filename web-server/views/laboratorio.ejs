<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
    <title>SIGLAB - Laborat√≥rio <%= lab.id %></title>
    
    <link href="/css/laboratorios.css" rel="stylesheet">
    
    <!-- Importando fontes retro para o modal -->
    <link href="https://fonts.googleapis.com/css2?family=VT323&family=Press+Start+2P&display=swap" rel="stylesheet">
</head>

<body>
    
    <%- include('partials/header') %> 

    <main>
        <h1 class="titulo-pagina"><%= lab.nome %></h1>

        <p class="subtitulo-localizacao">
            <%= lab.localizacao %>
        </p>

        <!-- pain√©is de informa√ß√£o (disponibilidade/avisos) -->
        <div class="info-panels-container">
            
            <a href="/disponibilidade/<%= lab.id %>" class="info-card-link">
                <div class="info-card">
                    <h2>Disponibilidade do Laborat√≥rio</h2>
                </div>
            </a>
            
            <a href="/laboratorios/<%= lab.id %>/avisos" class="info-card-link">
                <div class="info-card">
                    <h2>Avisos</h2>
                </div>
            </a>

            <% if (user && user.tipo === 'admin') { %>
                <a href="/historico/<%= lab.id %>" class="info-card-link">
                    <div class="info-card">
                        <h2>Hist√≥rico</h2>
                    </div>
                </a>
            <% } %>
        </div>

        <!-- MODAL DE CADASTRO DE DISPOSITIVO -->
        <% if (user && user.tipo === 'admin') { %>
            <div id="modalDispositivo" class="modal">
                <div class="modal-content">
                    <span class="close-btn" onclick="closeModal()">&times;</span>
                    <h3>> Gerenciar_Dispositivos_</h3>
                    
                    <!-- Cadastro Manual -->
                    <form action="/laboratorios/<%= lab.id %>/dispositivos" method="POST" class="modal-form">
                        <label style="color: #fff; border-bottom: 1px solid #005500; padding-bottom: 5px;">[ MODO MANUAL ]</label>
                        
                        <label for="nome">Nome do Dispositivo:</label>
                        <input type="text" id="nome" name="nome" placeholder="Ex: PC_01" required>
                        
                        <label for="tipo">Tipo:</label>
                        <select id="tipo" name="tipo" required>
                            <option value="" disabled selected>SELECIONE...</option>
                            <option value="computador">COMPUTADOR</option>
                            <option value="projetor">PROJETOR</option>
                            <option value="impressora">IMPRESSORA</option>
                        </select>
                        
                        <label for="status">Status Inicial:</label>
                        <select id="status" name="status" required>
                            <option value="livre">LIVRE</option>
                            <option value="em_uso">EM USO</option>
                            <option value="inoperante">INOPERANTE</option>
                        </select>

                        <button type="submit">CONFIRMAR INSER√á√ÉO</button>
                    </form>

                    <!-- Divis√≥ria Visual -->
                    <div class="modal-divider">
                        <span>OU IMPORTAR EM MASSA</span>
                    </div>

                    <!-- Importa√ß√£o CSV -->
                    <div class="import-section">
                        <!-- Input Escondido para Upload -->
                        <input type="file" id="csvFileInput" accept=".csv" style="display: none;" onchange="handleFileSelect(event)">
                        
                        <button onclick="document.getElementById('csvFileInput').click()" class="btn-action btn-import-modal">
                            üì• Carregar Arquivo CSV
                        </button>
                        <p style="font-size: 0.9rem; color: #005500; margin-top: 5px;">*Formato: Nome,Tipo,Status</p>
                    </div>
                </div>
            </div>
        <% } %>

        <!-- container da topologia -->
        <div class="topology-container">
            <!-- HEADER DA TOPOLOGIA COM BOT√ÉO DE ADMIN -->
            <div class="topology-header">
                <h2>Topologia do Laborat√≥rio</h2>
                
                <% if (user && user.tipo === 'admin') { %>
                    <button onclick="openModal()" class="btn-action">
                        <h3>+ Novo Dispositivo</h3>
                    </button>
                <% } %>
            </div>
            
            <div class="topology-map">
                <!-- 
                  looping EJS para listar os dispositivos 
                -->
                <% if (lab.dispositivos && lab.dispositivos.length > 0) { %>
                    <% lab.dispositivos.forEach(disp => { %>
                        
                        <!-- 
                           Dispositivo Compacto (preparado para drag and drop)
                           Classe do status no container pai para cor da borda
                        -->
                        <div class="device <%= disp.status %>">
                            
                            <!-- Texto visual do status AGORA NO TOPO -->
                            <span class="status-label">
                                <%= disp.status.replace('_', ' ') %>
                            </span>

                            <span class="device-icon">
                                <% if (disp.tipo === 'projetor') { %>
                                    üìΩÔ∏è
                                <% } else if (disp.tipo === 'impressora') { %>
                                    üñ®Ô∏è
                                <% } else { %>
                                    üñ•Ô∏è
                                <% } %>
                            </span>

                            <!-- Tooltip (Menu de a√ß√µes e detalhes) -->
                            <div class="tooltip">
                                <div class="tooltip-content">
                                    <p><strong>ID:</strong> <%= disp.nome %></p>
                                    <p><strong>Tipo:</strong> <%= disp.tipo %></p>
                                    <hr style="border-color: inherit; margin: 5px 0; opacity: 0.5;">
                                    
                                    <a href="/laboratorios/<%= lab.id %>/report/<%= disp.id_dispositivo %>" class="tooltip-btn btn-report">Reportar Problema</a>
                                    
                                    <% if (user && user.tipo === 'admin') { %>
                                        <form action="/laboratorios/<%= lab.id %>/dispositivos/<%= disp.id_dispositivo %>/delete" method="POST" onsubmit="return confirm('ATEN√á√ÉO ADMIN:\n\nTem certeza que deseja EXCLUIR permanentemente o dispositivo \'<%= disp.nome %>\'?');">
                                            <button type="submit" class="tooltip-btn btn-delete-device">Excluir</button>
                                        </form>
                                    <% } %>
                                </div>
                            </div>
                        </div>
                    
                    <% }); %>
                <% } else { %>
                    <p style="width: 100%; text-align: center; color: #666; font-size: 1.2rem; margin-top: 50px;">
                        [ SISTEMA: Nenhum dispositivo detectado neste setor. ]
                    </p>
                <% } %>
            </div>
        </div>
    </main>

    <%- include('partials/footer') %> 

    <!-- SCRIPTS PARA MODAL E IMPORTA√á√ÉO CSV -->
    <script>
        // --- L√ìGICA DO MODAL ---
        const modal = document.getElementById("modalDispositivo");
        
        function openModal() {
            if(modal) modal.style.display = "block";
        }

        function closeModal() {
            if(modal) modal.style.display = "none";
        }

        window.onclick = function(event) {
            if (event.target == modal) {
                closeModal();
            }
        }

        // --- L√ìGICA DE IMPORTA√á√ÉO CSV ---
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();

            reader.onload = function(e) {
                const text = e.target.result;
                processCSV(text);
            };

            reader.readAsText(file);
        }

        function processCSV(csvText) {
            const lines = csvText.trim().split(/\r\n|\n/);
            
            if (lines.length < 2) {
                alert("Erro: Arquivo CSV vazio ou inv√°lido.");
                return;
            }

            const dispositivos = [];

            for (let i = 1; i < lines.length; i++) {
                const row = lines[i].split(',');
                
                if (row.length >= 3) {
                    const nome = row[0].trim();
                    const tipo = row[1].trim();
                    const status = row[2].trim();

                    if (nome && tipo) {
                        dispositivos.push({ nome, tipo, status });
                    }
                }
            }

            if (dispositivos.length === 0) {
                alert("Nenhum dispositivo v√°lido encontrado no CSV.");
                return;
            }

            sendDataToServer(dispositivos);
        }

        async function sendDataToServer(data) {
            const idLab = "<%= lab.id %>";
            
            try {
                const response = await fetch(`/laboratorios/${idLab}/importar`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ dispositivos: data })
                });

                const result = await response.json();

                if (result.success) {
                    alert(result.message);
                    window.location.reload(); 
                } else {
                    alert("Erro ao importar: " + result.message);
                }

            } catch (error) {
                console.error("Erro:", error);
                alert("Erro de conex√£o ao tentar importar.");
            }
        }
    </script>

</body>
</html>