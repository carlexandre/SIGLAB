<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIGLAB: Disponibilidade</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=VT323&display=swap" rel="stylesheet">
    <link href="/css/disponibilidade.css" rel="stylesheet">
</head>

<body>
    
    <%- include('partials/header') %>

    <main>
        <h1 class="titulo-pagina">Agenda de Laboratórios</h1>

        <div class="agenda-container">
            
            <!-- calendário -->
            <div class="calendar-wrapper">
                <div class="calendar-header">
                    <button class="btn-nav" onclick="mudarMes(-1)">&lt; ANT</button>
                    <span id="mesAnoDisplay" style="color: #fff;">NOVEMBRO 2025</span>
                    <button class="btn-nav" onclick="mudarMes(1)">PROX &gt;</button>
                </div>

                <div class="calendar-grid">
                    <!-- dias da semana -->
                    <div class="weekday">DOM</div>
                    <div class="weekday">SEG</div>
                    <div class="weekday">TER</div>
                    <div class="weekday">QUA</div>
                    <div class="weekday">QUI</div>
                    <div class="weekday">SEX</div>
                    <div class="weekday">SÁB</div>

                    <!-- os dias serão gerados via JS -->
                    <div id="diasContainer" style="display: contents;"></div>
                </div>
            </div>

            <aside class="details-panel">
                <div class="details-header">
                    <div class="details-date" id="displayDataSelecionada">SELECIONE UM DIA</div>
                    <div style="font-size: 0.9rem; color: #888;">Detalhes da ocupação</div>
                </div>

                <ul class="reservation-list" id="listaReservas">
                    <li class="empty-state">Clique em um dia no calendário para ver a disponibilidade.</li>
                </ul>

                <a href="#" id="btnNovaReserva" class="btn-reservar" style="display: none;">
                    + NOVA RESERVA NESTE DIA
                </a>
            </aside>

        </div>
    </main>

    <%- include('partials/footer') %>

    <script>
        // --- MOCK DE DADOS (Substitua pelo que vem do Back-end) ---
        // Formato: "YYYY-MM-DD": [Array de reservas]
        const reservasDB = {
            "2025-11-05": [
                { lab: "LAB-01", hora: "08:00 - 10:00", user: "Prof. Miguel", tipo: "Aula" },
                { lab: "LAB-03", hora: "14:00 - 16:00", user: "Turma Eng. Software", tipo: "Prática" }
            ],
            "2025-11-12": [
                { lab: "LAB-02", hora: "10:00 - 12:00", user: "Manutenção TI", tipo: "Bloqueio" }
            ],
            "2025-11-20": [
                { lab: "LAB-01", hora: "08:00 - 12:00", user: "Hackathon", tipo: "Evento" },
                { lab: "LAB-01", hora: "13:00 - 18:00", user: "Hackathon", tipo: "Evento" }
            ]
        };

        let dataAtual = new Date();
        let diaSelecionado = null;

        const nomesMeses = ["JANEIRO", "FEVEREIRO", "MARÇO", "ABRIL", "MAIO", "JUNHO", "JULHO", "AGOSTO", "SETEMBRO", "OUTUBRO", "NOVEMBRO", "DEZEMBRO"];

        function renderizarCalendario() {
            const ano = dataAtual.getFullYear();
            const mes = dataAtual.getMonth();

            // Atualiza título
            document.getElementById('mesAnoDisplay').innerText = `${nomesMeses[mes]} ${ano}`;

            const container = document.getElementById('diasContainer');
            container.innerHTML = '';

            // Primeiro dia do mês e total de dias
            const primeiroDiaSemana = new Date(ano, mes, 1).getDay();
            const diasNoMes = new Date(ano, mes + 1, 0).getDate();

            // Células vazias antes do dia 1
            for (let i = 0; i < primeiroDiaSemana; i++) {
                const empty = document.createElement('div');
                empty.classList.add('day-cell');
                empty.style.border = 'none'; // Invisível
                empty.style.cursor = 'default';
                container.appendChild(empty);
            }

            // Dias do mês
            for (let dia = 1; dia <= diasNoMes; dia++) {
                const el = document.createElement('div');
                el.classList.add('day-cell');
                
                // Formata data string YYYY-MM-DD
                const diaStr = dia.toString().padStart(2, '0');
                const mesStr = (mes + 1).toString().padStart(2, '0');
                const dataKey = `${ano}-${mesStr}-${diaStr}`;

                // Verifica se tem reservas
                const temReservas = reservasDB[dataKey];
                const qtdReservas = temReservas ? temReservas.length : 0;

                // HTML interno da célula
                let htmlConteudo = `<div class="day-number">${dia}</div>`;
                
                if (qtdReservas > 0) {
                    htmlConteudo += `<div class="day-indicator">`;
                    // Adiciona um quadrado para cada reserva (max 3 visualmente)
                    for(let k=0; k<Math.min(qtdReservas, 4); k++) {
                        htmlConteudo += `<span class="dot"></span>`;
                    }
                    htmlConteudo += `</div>`;
                }

                el.innerHTML = htmlConteudo;

                // Evento de Click
                el.onclick = () => selecionarDia(el, dataKey, dia, mes, ano);

                container.appendChild(el);
            }
        }

        function selecionarDia(elemento, dataKey, dia, mes, ano) {
            // Remove classe active dos outros
            document.querySelectorAll('.day-cell').forEach(d => d.classList.remove('active'));
            elemento.classList.add('active');

            // Atualiza painel lateral
            const dataFormatada = `${dia} de ${nomesMeses[mes]} de ${ano}`;
            document.getElementById('displayDataSelecionada').innerText = dataFormatada;
            
            const lista = document.getElementById('listaReservas');
            lista.innerHTML = ''; // Limpa lista

            const reservas = reservasDB[dataKey];

            if (reservas && reservas.length > 0) {
                reservas.forEach(res => {
                    const li = document.createElement('li');
                    li.classList.add('reservation-item');
                    li.innerHTML = `
                        <div class="res-time">${res.hora}</div>
                        <div class="res-lab">${res.lab}</div>
                        <div class="res-user">${res.user} - ${res.tipo}</div>
                    `;
                    lista.appendChild(li);
                });
            } else {
                lista.innerHTML = `<li class="empty-state">Nenhuma reserva encontrada para este dia.<br>O laboratório está livre.</li>`;
            }

            // Atualiza botão de nova reserva
            const btn = document.getElementById('btnNovaReserva');
            // Exemplo de link dinâmico
            btn.href = `/laboratorios/reserva?data=${dataKey}`;
            btn.style.display = 'block';
            btn.innerText = `+ RESERVAR PARA ${dia}/${mes+1}`;
        }

        function mudarMes(delta) {
            dataAtual.setMonth(dataAtual.getMonth() + delta);
            renderizarCalendario();
        }

        // Inicia
        document.addEventListener('DOMContentLoaded', renderizarCalendario);

    </script>
</body>
</html>